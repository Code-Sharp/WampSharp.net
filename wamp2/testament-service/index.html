<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate href=/index.xml type=application/rss+xml title=WampSharp><link rel=icon href=https://wampsharp.net/favicon.ico><title>Testament service - WampSharp</title><link rel=stylesheet href=https://wampsharp.net/css/highlight/github.css><link rel=stylesheet href=https://wampsharp.net/css/bootstrap.min.css><link rel=stylesheet href=https://wampsharp.net/css/bootstrap-theme.min.css><link rel=stylesheet href=https://wampsharp.net/css/theme.css><link rel=stylesheet href=https://wampsharp.net/css/bootie-docs.css><link rel=stylesheet href=https://wampsharp.net/css/site.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@v2.6.3/dist/cdn/docsearch.min.css></head><body role=document><nav class="navbar navbar-inverse navbar-fixed-top"><div class=container><div class=navbar-header><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#navbar aria-expanded=false aria-controls=navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://wampsharp.net/>WampSharp</a></div><div id=navbar class="navbar-collapse collapse"><ul class="nav navbar-nav"><li><a href=https://wampsharp.net/>Home</a></li><li class=dropdown><a href=# class=dropdown-toggle data-toggle=dropdown role=button aria-expanded=false>Categories<span class=caret></span></a><ul class=dropdown-menu role=menu><li><a href=https://wampsharp.net/categories/authentication>Authentication</a></li><li><a href=https://wampsharp.net/categories/callee>Callee</a></li><li><a href=https://wampsharp.net/categories/caller>Caller</a></li><li><a href=https://wampsharp.net/categories/client>Client</a></li><li><a href=https://wampsharp.net/categories/getting-started>Getting-Started</a></li><li><a href=https://wampsharp.net/categories/publisher>Publisher</a></li><li><a href=https://wampsharp.net/categories/release-notes>Release-Notes</a></li><li><a href=https://wampsharp.net/categories/roadmap>Roadmap</a></li><li><a href=https://wampsharp.net/categories/router>Router</a></li><li><a href=https://wampsharp.net/categories/subscriber>Subscriber</a></li><li><a href=https://wampsharp.net/categories/wamp1>Wamp1</a></li></ul></li></ul><form class="navbar-form navbar-left" role=search><div class="input-group doc-search-form"><input type=text id=as_q class="search-query doc-search-input-text" placeholder="Search Site"></div></form></div></div></nav><div class=container><div class=row><div class="col-sm-8 doc-main"><main role=main><article><a id=title></a><h1 class=doc-entry-title>Testament service</h1><div class=doc-entry-meta><span><time datetime=2017-07-30>July 30, 2017</time></span></div><section><p>The <a href=http://wamp-proto.org/static/rfc/draft-oberstet-hybi-crossbar-wamp.html#rfc.section.14.4.11>Testament feature</a> is supported.</p><p>This feature allows a client to request the router to publish some predefined events when the client disconnects.</p><h2 id=enabling-the-testament-service-on-the-router-side>Enabling the testament service on the router-side</h2><p>In order to enable it from router-side, call HostTestamentService extension method of the relevant realm (this is similiar to the <a href=https://wampsharp.net/wamp2/meta-api-service/#exposing-meta-api>Router-side meta-api usage</a>):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp>DefaultWampHost host = <span style=color:#66d9ef>new</span> DefaultWampHost(<span style=color:#e6db74>&#34;ws://127.0.0.1:8080/ws&#34;</span>);

IWampHostedRealm realm = host.RealmContainer.GetRealmByName(<span style=color:#e6db74>&#34;realm1&#34;</span>);

IDisposable disposable = realm.HostTestamentService();

<span style=color:#75715e>// Uncomment to unregister the Testament service. 
</span><span style=color:#75715e>// disposable.Dispose(); 
</span><span style=color:#75715e></span>
host.Open();
</code></pre></div><h2 id=consuming-the-testament-service>Consuming the testament service</h2><p>In order to consume the Testament service, one can define its contract and consume it using the CalleeProxy method. Another option is to use the GetTestamentServiceProxy extension method of IWampRealmProxy which returns such a proxy:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>async</span> Task Main()
{
    WampChannelFactory channelFactory = <span style=color:#66d9ef>new</span> WampChannelFactory();

    IWampChannel channel =
        channelFactory.ConnectToRealm(<span style=color:#e6db74>&#34;realm1&#34;</span>)
                      .WebSocketTransport(<span style=color:#66d9ef>new</span> Uri(<span style=color:#e6db74>&#34;ws://127.0.0.1:8080/ws&#34;</span>))
                      .JsonSerialization()
                      .Build();

    TaskCompletionSource&lt;<span style=color:#66d9ef>long</span>&gt; sessionIdTask = <span style=color:#66d9ef>new</span> TaskCompletionSource&lt;<span style=color:#66d9ef>long</span>&gt;();

    channel.RealmProxy.Monitor.ConnectionEstablished += (sender, args) =&gt; sessionIdTask.SetResult(args.SessionId);

    <span style=color:#66d9ef>await</span> channel.Open().ConfigureAwait(<span style=color:#66d9ef>false</span>);

    <span style=color:#66d9ef>long</span> sessionId = <span style=color:#66d9ef>await</span> sessionIdTask.Task.ConfigureAwait(<span style=color:#66d9ef>false</span>);

    IWampTestamentServiceProxy proxy = channel.RealmProxy.GetTestamentServiceProxy();

    <span style=color:#66d9ef>string</span> testamentTopic = <span style=color:#e6db74>&#34;com.example.testament&#34;</span>;

    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i = <span style=color:#ae81ff>0</span>; i &lt; <span style=color:#ae81ff>5</span>; ++i)
    {
        <span style=color:#66d9ef>object</span>[] testamentArgs = <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>object</span>[] {<span style=color:#e6db74>&#34;this is my testament!&#34;</span>};

        Dictionary&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>object</span>&gt; testamentKwArgs =
            <span style=color:#66d9ef>new</span> Dictionary&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>object</span>&gt; {{<span style=color:#e6db74>&#34;foo&#34;</span>, i}, {<span style=color:#e6db74>&#34;bar&#34;</span>, <span style=color:#e6db74>&#34;baz&#34;</span>}, {<span style=color:#e6db74>&#34;sess&#34;</span>, sessionId}};

        <span style=color:#66d9ef>try</span>
        {
            <span style=color:#66d9ef>await</span> proxy.AddTestamentAsync(testamentTopic, testamentArgs, testamentKwArgs)
                       .ConfigureAwait(<span style=color:#66d9ef>false</span>);

            Console.WriteLine(<span style=color:#e6db74>&#34;testament added&#34;</span>);
        }
        <span style=color:#66d9ef>catch</span> (Exception ex)
        {
            Console.WriteLine(<span style=color:#e6db74>&#34;adding testament failed! &#34;</span> + ex);
        }
    }

    Console.WriteLine(<span style=color:#e6db74>@&#34;Press any key to close channel. 5 events should be published to &#34;&#34;com.example.testament&#34;&#34;&#34;</span>);

    <span style=color:#75715e>// This line is required in order to release the WebSocket thread, otherwise it will be blocked by the following Console.ReadKey() line.
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> Task.Yield();

    Console.ReadKey();
    channel.Close();
}
</code></pre></div><blockquote><p>This sample is based on this <a href=https://github.com/crossbario/crossbar-examples/tree/240c1f015990a859683a74de40e51a9f9ab3b5f9/pubsub/testament>Crossbar example</a>.</p></blockquote></section></article></main></div><div class="col-sm-3 col-sm-offset-1 doc-sidebar"><div id=sidebar><div class=sidebar-module><div class=sidebar-toc><h4 class=sidebar-heading>Table of Contents</h4><ul><li><strong><a href=#title>Testament service</a></strong></li></ul><nav id=TableOfContents><ul><li><a href=#enabling-the-testament-service-on-the-router-side>Enabling the testament service on the router-side</a></li><li><a href=#consuming-the-testament-service>Consuming the testament service</a></li></ul></nav></div></div><div class=sidebar-module><h4 class=sidebar-heading>Pages in Categories</h4><ul class=sidebar-category-list><li><a href=https://wampsharp.net/categories/authentication><span class=doc-list-category>Authentication</span></a><ul><li><a href=/wamp2/client/client-side-authentication/>Client-side authentication</a></li><li><a href=/wamp2/router/cookie-based-router-side-authentication/>Cookie based router-side authentication</a></li><li><a href=/wamp2/router/router-side-authentication/>Router-side authentication</a></li><li><a href=/wamp2/client/wamp-cra-client-side-authentication/>WAMP-CRA client side authentication</a></li><li><a href=/wamp2/router/wamp-cra-router-side-authentication/>WAMP-CRA router-side authentication</a></li></ul></li><li><a href=https://wampsharp.net/categories/callee><span class=doc-list-category>Callee</span></a><ul><li><a href=/wamp2/roles/callee/getting-started-with-callee/>Getting started with Callee</a></li><li><a href=/wamp2/roles/callee/raw-callee/>Raw Callee</a></li><li><a href=/wamp2/roles/callee/reflection-based-callee/>Reflection-based Callee</a></li></ul></li><li><a href=https://wampsharp.net/categories/caller><span class=doc-list-category>Caller</span></a><ul><li><a href=/wamp2/roles/caller/getting-started-with-caller/>Getting started with Caller</a></li><li><a href=/wamp2/roles/caller/raw-caller/>Raw Caller</a></li><li><a href=/wamp2/roles/caller/reflection-based-caller/>Reflection-based Caller</a></li></ul></li><li><a href=https://wampsharp.net/categories/client><span class=doc-list-category>Client</span></a><ul><li><a href=/wamp2/router/transports/rawsocket/>RawSocket transport</a></li><li><a href=/wamp2/client/client-side-authentication/>Client-side authentication</a></li><li><a href=/wamp2/meta-api-service/>Meta-api descriptor service</a></li><li><span class=active>Testament service</span></li><li><a href=/wamp2/client/wamp-cra-client-side-authentication/>WAMP-CRA client side authentication</a></li><li><a href=/wamp2/client/wampchannel/>WampChannel</a></li><li><a href=/wamp2/client/wampchannelreconnector/>WampChannelReconnector</a></li></ul></li><li><a href=https://wampsharp.net/categories/getting-started><span class=doc-list-category>Getting-Started</span></a><ul><li><a href=/wamp2/roles/callee/getting-started-with-callee/>Getting started with Callee</a></li><li><a href=/wamp2/roles/caller/getting-started-with-caller/>Getting started with Caller</a></li><li><a href=/wamp2/roles/publisher/getting-started-with-publisher/>Getting started with Publisher</a></li><li><a href=/wamp2/roles/subscriber/getting-started-with-subscriber/>Getting started with Subscriber</a></li><li><a href=/wamp2/getting-started-with-wampv2/>Getting started with WAMPv2</a></li></ul></li><li><a href=https://wampsharp.net/categories/publisher><span class=doc-list-category>Publisher</span></a><ul><li><a href=/wamp2/roles/publisher/getting-started-with-publisher/>Getting started with Publisher</a></li><li><a href=/wamp2/roles/publisher/raw-publisher/>Raw Publisher</a></li><li><a href=/wamp2/roles/publisher/reflection-based-publisher/>Reflection-based Publisher</a></li><li><a href=/wamp2/roles/publisher/rx-based-publisher/>Rx-based Publisher</a></li></ul></li><li><a href=https://wampsharp.net/categories/release-notes><span class=doc-list-category>Release-Notes</span></a><ul><li><a href=/release-notes/wampsharp-v20.1.1-release-notes/>WampSharp v20.1.1 release notes</a></li><li><a href=/release-notes/wampsharp-v18.6.1-release-notes/>WampSharp v18.6.1 release notes</a></li><li><a href=/release-notes/wampsharp-v1.2.6.41-beta-release-notes/>WampSharp v1.2.6.41-beta release notes</a></li><li><a href=/release-notes/wampsharp-v1.2.5.21-beta-release-notes/>WampSharp v1.2.5.21-beta release notes</a></li><li><a href=/release-notes/wampsharp-v1.2.4.18-beta-release-notes/>WampSharp v1.2.4.18-beta release notes</a></li><li><a href=/release-notes/wampsharp-v1.2.3.12-beta-release-notes/>WampSharp v1.2.3.12-beta release notes</a></li><li><a href=/release-notes/wampsharp-v1.2.2.8-beta-release-notes/>WampSharp v1.2.2.8-beta release notes</a></li><li><a href=/release-notes/wampsharp-v1.2.1.6-beta-release-notes/>WampSharp v1.2.1.6-beta release notes</a></li></ul></li><li><a href=https://wampsharp.net/categories/roadmap><span class=doc-list-category>Roadmap</span></a><ul><li><a href=/roadmap/>Roadmap</a></li></ul></li><li><a href=https://wampsharp.net/categories/router><span class=doc-list-category>Router</span></a><ul><li><a href=/wamp2/router/transports/rawsocket/>RawSocket transport</a></li><li><a href=/wamp2/router/transports/websocket/>WebSocket transports</a></li><li><a href=/wamp2/router/cookie-based-router-side-authentication/>Cookie based router-side authentication</a></li><li><a href=/wamp2/meta-api-service/>Meta-api descriptor service</a></li><li><a href=/wamp2/router/router-side-authentication/>Router-side authentication</a></li><li><span class=active>Testament service</span></li><li><a href=/wamp2/router/wamp-cra-router-side-authentication/>WAMP-CRA router-side authentication</a></li><li><a href=/wamp2/router/wamphost/>WampHost</a></li></ul></li><li><a href=https://wampsharp.net/categories/subscriber><span class=doc-list-category>Subscriber</span></a><ul><li><a href=/wamp2/roles/subscriber/getting-started-with-subscriber/>Getting started with Subscriber</a></li><li><a href=/wamp2/roles/subscriber/raw-subscriber/>Raw Subscriber</a></li><li><a href=/wamp2/roles/subscriber/reflection-based-subscriber/>Reflection-based Subscriber</a></li><li><a href=/wamp2/roles/subscriber/rx-based-subscriber/>Rx-based Subscriber</a></li></ul></li><li><a href=https://wampsharp.net/categories/wamp1><span class=doc-list-category>Wamp1</span></a><ul><li><a href=/wamp1/getting-started-with-wampv1/>Getting started with WAMPv1</a></li><li><a href=/wamp1/getting-started-with-wampv1-client/>Getting started with WAMPv1 client</a></li><li><a href=/wamp1/notes-for-wampv1-users/>Notes for WAMP1 users</a></li><li><a href=/wamp1/server-pubsub-hosting-wampv1/>Server PubSub hosting (WAMPv1)</a></li><li><a href=/wamp1/server-rpc-hosting-wampv1/>Server RPC hosting (WAMPv1)</a></li></ul></li></ul></div><div class=sidebar-module><h4 class=sidebar-heading>Tags</h4><div class=tag-box><a class=tag-item href=https://wampsharp.net/tags/authentication>authentication</a>
<a class=tag-item href=https://wampsharp.net/tags/callee>callee</a>
<a class=tag-item href=https://wampsharp.net/tags/caller>caller</a>
<a class=tag-item href=https://wampsharp.net/tags/client>client</a>
<a class=tag-item href=https://wampsharp.net/tags/publisher>publisher</a>
<a class=tag-item href=https://wampsharp.net/tags/raw-api>raw-api</a>
<a class=tag-item href=https://wampsharp.net/tags/reflection>reflection</a>
<a class=tag-item href=https://wampsharp.net/tags/roadmap>roadmap</a>
<a class=tag-item href=https://wampsharp.net/tags/router>router</a>
<a class=tag-item href=https://wampsharp.net/tags/rx>rx</a>
<a class=tag-item href=https://wampsharp.net/tags/services>services</a>
<a class=tag-item href=https://wampsharp.net/tags/subscriber>subscriber</a>
<a class=tag-item href=https://wampsharp.net/tags/transports>transports</a>
<a class=tag-item href=https://wampsharp.net/tags/wamp1>wamp1</a>
<a class=tag-item href=https://wampsharp.net/tags/wampcra>wampcra</a></div></div></div></div></div><hr><div class=row><div class=col-sm-8><p class=doc-footer-em><a href=# onclick=resetSidebarPos()>Back to TOP</a></p></div></div></div><footer class=doc-footer><p class=doc-footer-em>Browse <strong><a href=https://github.com/Code-Sharp/WampSharp.net/>Repository</a></strong></p><p>Copyright (c) 2013-2020, Elad Zelingher; All rights reserved.</p><p>Powered by <strong><a href=https://github.com/progrhyme/hugo-theme-bootie-docs>Bootie Docs</a></strong> - theme for <a href=http://gohugo.io/>Hugo</a> by <a href=https://github.com/progrhyme/>progrhyme</a>.</p></footer><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-98663639-2','auto');ga('send','pageview');</script><script src=https://wampsharp.net/js/jquery.min.js></script><script src=https://wampsharp.net/js/bootstrap.min.js></script><script src=https://wampsharp.net/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script src=https://wampsharp.net/js/ie10-viewport-bug-workaround.js></script><script src=https://wampsharp.net/js/bootie-docs.js></script><script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><script>docsearch({apiKey:'0327efc17cad5f4c0585144de916a164',indexName:'wampsharp',inputSelector:'#as_q',debug:false,});</script></body></html>